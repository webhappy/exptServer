var sRNA=Glyph.extend({init:function(b,e,a,c,f,d){this._super(b,e,a,c,d);this.height=f;this.glyphType="sRNA"},draw:function(b){var e=e||this.getPixelLength(),a=this.height,c=e,f=this.getPixelPositionX(),f=new Kinetic.Group({offsetX:-f,offsetY:0}),d=new Kinetic.Group({}),c=new Kinetic.Line({points:[0,-a,c,-a],stroke:"orange",closed:!1});d.add(c);"-"==this.strand&&d.scale({x:-1,y:1});f.add(d);f.msg=this.name+" is sRNA  has height "+a;f.on("mouseover",function(){writeMessage(this.msg)});f.on("mouseout",
function(){writeMessage("")});f.add(d);a=new Kinetic.Text({text:this.name,x:e/2,y:-a,fontSize:14,fill:"black"});a.offsetX(a.width()/2);"-"==this.strand&&a.offsetX(e);f.add(a);b.add(f)}}),Promoter=Glyph.extend({init:function(b,e,a,c,f,d){this._super(b,e,a,c,d);this.height=f;this.glyphType="Promoter"},draw:function(b){var e=e||this.getPixelLength(),a=this.height,c=e-10,f=this.getPixelPositionX(),d=new Kinetic.Group({offsetX:-f,offsetY:0}),h=new Kinetic.Group({}),g=new Kinetic.Line({points:[0,0,0,-a,
c,-a],stroke:"black",closed:!1}),c=new Kinetic.Line({points:[c,-a-5,c,-a+5,e,-a],stroke:"black",fill:"black",closed:!0});Math.round(a/4);Math.round(a/2);f=this.getPixelPositionX();h.add(g);h.add(c);"-"==this.strand&&h.scale({x:-1,y:1});d.add(h);d.msg=this.name+" starts at "+this.position+" for length "+this.length+" nt";d.on("mouseover",function(){writeMessage(this.msg)});d.on("mouseout",function(){writeMessage("")});d.add(h);a=new Kinetic.Text({text:this.name,x:e/2,y:-a,fontSize:12,fill:"black",
offsetY:15});"-"==this.strand?a.offsetX(e+5):a.offsetX(e-a.width()/2);d.add(a);b.add(d)}});var Arrow=Glyph.extend({init:function(b,e,a,c){this._super(b,e,0,a,c);this.slope=1;this.glyphType="Arrow";this.thickness=4.6},getPixelThickness:function(){var b=this.getHeight()/2/Math.tan(Math.atan(this.slope));return this.thickness/10*b},erase:function(){var b=this.getPixelThickness();this.ctx.clearRect(-b,0,b,this.getHeight())},_draw:function(b,e,a,c){b=b||this.ctx;a=a||this.getHeight();c=c+1||this.calcRoundness();void 0!=c&&(c-=1);e=this.getPixelThickness();x=y=0;a_b_x=x-0-c;a_t_x=x-0-c;a_max_x=
x-0;t=0.5;a_ctrl_x=(a_max_x-(1-t)*(1-t)*a_b_x-t*t*a_t_x)/(2*(1-t)*t);a_ctrl_y=y+a/2;bs_slope=this.slope;bs_intercept=-a_ctrl_y-bs_slope*a_ctrl_x;ts_slope=-this.slope;ts_intercept=-a_ctrl_y-ts_slope*a_ctrl_x;a_b_y=-(bs_slope*a_b_x+bs_intercept);a_t_y=-(ts_slope*a_t_x+ts_intercept);b.beginPath();bs_ctrl_y=y+a;bs_ctrl_x=(-bs_ctrl_y-bs_intercept)/this.slope;bs_slpe_x=bs_ctrl_x+c+c;bs_slpe_y=-(bs_slope*bs_slpe_x+bs_intercept);b.moveTo(bs_slpe_x,bs_slpe_y);b.lineTo(a_b_x,a_b_y);b.quadraticCurveTo(a_ctrl_x,
a_ctrl_y,a_t_x,a_t_y);ts_ctrl_y=y;ts_ctrl_x=(ts_ctrl_y+ts_intercept)/this.slope;ts_slpe_x=ts_ctrl_x+c+c;ts_slpe_y=-(ts_slope*ts_slpe_x+ts_intercept);b.lineTo(ts_slpe_x,ts_slpe_y);var f=Math.PI-Math.abs(Math.atan(this.slope))-Math.PI/2;c=Math.sin(f)*e;f=Math.cos(f)*e;b.bezierCurveTo(ts_ctrl_x,ts_ctrl_y,ts_ctrl_x-c,ts_ctrl_y+f,ts_slpe_x-c,ts_slpe_y+f);b.lineTo(a_max_x-e,y+a/2);b.lineTo(bs_slpe_x-c,bs_slpe_y-f);b.bezierCurveTo(bs_ctrl_x-c,bs_ctrl_y-f,bs_ctrl_x,bs_ctrl_y,bs_slpe_x,bs_slpe_y)}});var geneGlyphCount=0,BlockArrow=Glyph.extend({init:function(b,e,a,c,f,d){this.chart=b;this._super(e,a,c,f);this.height=d;this.glyphType="BlockArrow"},draw:function(b){var e=e||this.getPixelLength(),a=Math.min(0.3*e,GENE_HEIGHT),c=Math.max(10,Math.round(a/4)),f=Math.max(18,Math.round(a/2)),d=e-a,h=this.getPixelPositionX(),h=new Kinetic.Group({offsetX:-h,offsetY:TFBS_HEIGHT+this.height}),c=new Kinetic.Line({points:[0,c,0,-c,d,-c,d,-f,e,0,d,f,d,c],stroke:"black",fill:"#ffbb73",id:"gene"+geneGlyphCount++,
closed:!0});"-"==this.strand?(c.scale({x:-1,y:1}),c.offsetX(e),a=(d/2+d+a)/2):a=(d+a/2)/2;h.msg=this.name+" starts at "+this.position;h.on("mouseover",function(){writeMessage(this.msg)});h.on("mouseout",function(){writeMessage("")});h.add(c);for(d=new Kinetic.Text({text:this.name,x:0,y:-6,fontSize:14,fill:"black"});10<d.fontSize()&&d.width()>e;)d.fontSize(d.fontSize()-1);e=a-d.width()/2;20>e-h.offsetX()?e=20+h.offsetX():e-h.offsetX()>this.chart.width-20&&(e=h.offsetX()+this.chart.width-60);d.setX(e);
h.add(d);b.add(h)}});var Complex=Glyph.extend({init:function(b,e,a,c,f,d){this._super(b,e,a,c,d);this.slope=1;this.glyphType="Complex";this.subFeatures=f;this.line=new Line(b,0,a);this.line.parent=this;this.line.color="black";this.line.thickness=2},addSubFeature:function(b){this.subFeatures.push(b)},_draw:function(b,e,a,c){b=b||this.ctx;e||this.getPixelLength();a||this.getHeight();c+1||this.calcRoundness();x=y=0;b.translate(-this.getPixelPositionX(),0);this.line.lane=this.lane;this.line.draw();e=this.subFeatures.length;
for(a=0;a<e;a++)this.subFeatures[a].parent=this,this.subFeatures[a].lane=this.lane,this.subFeatures[a].draw();b.translate(this.getPixelPositionX(),0);b.beginPath()}});var Line=Glyph.extend({init:function(b,e,a,c){this.thickness=2;this._super(b,e,a,void 0,c);this.glyphType="Line"},_draw:function(b,e,a,c){b=b||this.ctx;e=e||this.getPixelLength();a=a||this.getHeight();x=y=0;b.beginPath();b.moveTo(x,a/2-this.thickness/2);b.lineTo(x,a/2+this.thickness/2);b.lineTo(x+e,a/2+this.thickness/2);b.lineTo(x+e,a/2-this.thickness/2)}});var Rect=Glyph.extend({init:function(b,e,a,c){this._super(b,e,a,void 0,c);this.glyphType="Rect"},_draw:function(b,e,a,c){b=b||this.ctx;e=e||this.getPixelLength();a=a||this.getHeight();c=c+1||this.calcRoundness();void 0!=c&&(c-=1);x=y=0;b.beginPath();tlc_ctrl_x=x;tlc_ctrl_y=y;tlc_lgth_x=x+c;tlc_lgth_y=y;tlc_wdth_x=x;tlc_wdth_y=y+c;blc_ctrl_x=x;blc_ctrl_y=y+a;blc_lgth_x=x+c;blc_lgth_y=y+a;blc_wdth_x=x;blc_wdth_y=y+a-c;brc_ctrl_x=x+e;brc_ctrl_y=y+a;brc_lgth_x=x+e-c;brc_lgth_y=y+a;brc_wdth_x=x+e;brc_wdth_y=
y+a-c;trc_ctrl_x=x+e;trc_ctrl_y=y;trc_lgth_x=x+e-c;trc_lgth_y=y;trc_wdth_x=x+e;trc_wdth_y=y+c;b.moveTo(tlc_lgth_x,tlc_lgth_y);b.quadraticCurveTo(tlc_ctrl_x,tlc_ctrl_y,tlc_wdth_x,tlc_wdth_y);b.lineTo(blc_wdth_x,blc_wdth_y);b.quadraticCurveTo(blc_ctrl_x,blc_ctrl_y,blc_lgth_x,blc_lgth_y);b.lineTo(brc_lgth_x,brc_lgth_y);b.quadraticCurveTo(brc_ctrl_x,brc_ctrl_y,brc_wdth_x,brc_wdth_y);b.lineTo(trc_wdth_x,trc_wdth_y);b.quadraticCurveTo(trc_ctrl_x,trc_ctrl_y,trc_lgth_x,trc_lgth_y);b.lineTo(tlc_lgth_x,tlc_lgth_y)}});var Seq=Glyph.extend({init:function(b,e,a,c,f){this.seq=c;this.insertions=[];this.fraction=1;this.fractionLevel=0.3;this.glyphType="Seq";this.font="8px courier";this.chars={};this.chars.width=void 0;this.chars.height=void 0;this.chars.list="AGTCN-".split("");this._super(b,e,a,void 0,f)},_draw:function(b,e,a){var c=1;this.lane.chart.convertPixelstoNts()<=this.fractionLevel&&(c=this.fraction);b=b||this.ctx;e=e||this.getPixelLength();a=a||this.getHeight();var f=this.getPixelPositionX(),d=this.getPixelPositionY(),
h=SCRIBL.chars;if(!h.heights[a]){h.heights[a]=[];for(var g=0;g<this.chars.list.length;g++){var k=this.chars.list[g],l=k;"-"==k&&(l="dash");this.createChar(k,h.nt_color,h["nt_"+l+"_bg"],a)}}x=y=0;if(this.imgCanvas)b.drawImage(this.imgCanvas,f,d-a*c,e,a*c);else{b.save();b.beginPath();b.textBaseline="middle";f=b.font;g=/[\d+px]/.exec(f)+"px";b.font=g+" courier";b.fillStyle="black";b.textAlign="left";g=this.seq.length*h.heights[a].width;this.imgCanvas=document.createElement("canvas");this.imgCanvas.width=
g;this.imgCanvas.height=a;d=this.imgCanvas.getContext("2d");for(g=l=k=0;g<this.seq.length;g++){h.heights[a][this.seq[g]]||this.createChar(this.seq[g],"black","white",a);var m=this.seq[g];this.insertions[l]&&void 0!=this.insertions[l].pos&&(this.insertions[l].pos-1==g?m+="rightInsert":this.insertions[l]&&this.insertions[l].pos==g&&(m+="leftInsert",l++));d.drawImage(h.heights[a][m],k,y);k+=h.heights[a].width}b.drawImage(this.imgCanvas,x,a-a*c,e,a*c);b.font=f;b.restore()}b.beginPath();b.moveTo(0,0);
b.lineTo(e,y);b.lineTo(e,y+a);b.lineTo(x,y+a);b.lineTo(x,y);b.fillStyle="rgba(0,0,0,0)";this.lane.chart.convertPixelstoNts()<=this.fractionLevel?b.strokeStyle="rgba(0,0,0,1)":b.strokeStyle="rgba(0,0,0,0)";b.stroke();b.closePath()},createChar:function(b,e,a,c){var f=document.createElement("canvas"),d=f.getContext("2d"),h=c-2;d.font=h+"px courier";var g=d.measureText(b).width+2;f.height=c;f.width=g;SCRIBL.chars.heights[c].width=g;f=document.createElement("canvas");d=f.getContext("2d");d.font=h+"px courier";
f.height=c;f.width=g;var k=d.fillStyle;d.fillStyle=a;d.fillRect(0,0,g,c);d.fillStyle=e;d.textAlign="center";d.textBaseline="middle";d.fillText(b,g/2,c/2);SCRIBL.chars.heights[c][b]=f;d.fillStyle=k;f=document.createElement("canvas");d=f.getContext("2d");d.font=h+"px courier";f.height=c;f.width=g;k=d.fillStyle;d.fillStyle=a;d.fillRect(0,0,g,c);d.fillStyle="yellow";d.beginPath();d.moveTo(0,c);d.arcTo(g,c,g,0,c/2);d.lineTo(g,c);d.lineTo(0,c);d.closePath();d.fill();d.fillStyle=e;d.textAlign="center";d.textBaseline=
"middle";d.fillText(b,g/2,c/2);SCRIBL.chars.heights[c][b+"rightInsert"]=f;d.fillStyle=k;f=document.createElement("canvas");d=f.getContext("2d");d.font=h+"px courier";f.height=c;f.width=g;k=d.fillStyle;d.fillStyle=a;d.fillRect(0,0,g,c);d.fillStyle="yellow";d.beginPath();d.moveTo(g,c);d.arcTo(0,c,0,0,c/2);d.lineTo(0,c);d.lineTo(g,c);d.closePath();d.fill();d.fillStyle=e;d.textAlign="center";d.textBaseline="middle";d.fillText(b,g/2,c/2);SCRIBL.chars.heights[c][b+"leftInsert"]=f;d.fillStyle=k}});var TFBS=Glyph.extend({init:function(b,e,a,c,f,d){this._super(b,e,a,c,d);this.height=f;this.glyphType="TFBS"},draw:function(b){var e=e||this.getPixelLength(),a=this.height,c=this.getPixelPositionX(),a=new Kinetic.Group({offsetX:-c,offsetY:a}),c=new Kinetic.Rect({x:0,y:0,width:e,height:-TFBS_HEIGHT,stroke:"black"});"-"==this.strand&&c.scale({x:-1,y:1});a.add(c);a.msg=this.name+" is TFBS  at position "+this.position+" for "+this.length+" nt";a.on("mouseover",function(){writeMessage(this.msg)});a.on("mouseout",
function(){writeMessage("")});for(c=new Kinetic.Text({text:this.name,x:0,y:-TFBS_HEIGHT/2,fontSize:15,fill:"black"});10<c.fontSize()&&c.width()>e;)c.fontSize(c.fontSize()-1);"-"==this.strand&&c.offsetX(e);a.add(c);b.add(a)}});var sgRNATicker=Glyph.extend({init:function(b,e,a,c){this._super("ticker",e,20,a);this.yVals=c;this.featureTrack=b;this.glyphType="ticker"},draw:function(b,e,a){for(b=0;b<this.yVals.length;b++);b=this.featureTrack.ctx;e=this.getPixelPositionX();b.save();a=this.getPixelLength();b.strokeRect(e,-20,a,-0.9*TFBS_HEIGHT);b.font="16px arial";b.fillStyle="black";b.restore()}});
